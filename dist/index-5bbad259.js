var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function e(t,e){return t(e={exports:{}},e.exports),e.exports}const n=(t,e,n="s")=>`${t} ${e}${1!==t?n:""}`;function o(t,e){for(let n=0,o=t.length;n<o&&!e(t[n],n,t);n++);return t}const i=new Map,r={set:(t,e)=>{i.set(t,e)},get:t=>i.has(t)?i.get(t):JSON.stringify({}),delete:t=>i.delete(t)};function s(t){const{client_id:e,client_secret:n,storage:o,...i}=t;this.client_id=e,this.client_secret=n||void 0,this.storage=o||r,this.fetch=t.fetch?t.fetch:fetch,this.options={host:t.host?t.host:"api.moltin.com",version:t.version?t.version:"v2",...i}}let a,c;function u(t){({client:a,stripeKey:c}=t),a.debounce=!1}function l(t,e){return fetch(t,{...e})}s.prototype.authenticate=async function(){const{client_id:t,client_secret:e,storage:n,options:{host:o}}=this;if(!t)throw Error("You must provide a client_id");const i=`https://${o}/oauth/access_token`,r={grant_type:e?"client_credentials":"implicit",client_id:t,...e&&{client_secret:e}},s=await this.fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-MOLTIN-SDK-LANGUAGE":"JS-REQUEST"},body:Object.keys(r).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(r[t])}`).join("&")}),{access_token:a,expires:c}=await s.json();if(!a)throw Error("Unable to obtain an access token");if(n){const e={client_id:t,access_token:a,expires:c};await n.set("moltinCredentials",JSON.stringify(e))}return a},s.prototype.request=async function(t,e,n,o){const{client_id:i,storage:r,options:{application:s,currency:a,customer_token:c,host:u,version:l,headers:p}}=this,d=`https://${u}/${l}/${f=e,f.replace(/^\/+/,"")}`;var f;const h={...p,...o};let m,g;r&&(m=await JSON.parse(r.get("moltinCredentials"))),g=!m||!m.access_token||m.client_id!==i||Math.floor(Date.now()/1e3)>=m.expires?await this.authenticate():m.access_token;const y={"Content-Type":"application/json","X-MOLTIN-SDK-LANGUAGE":"JS-REQUEST",Authorization:`Bearer ${g}`,...s&&{"X-MOLTIN-APPLICATION":s},...a&&{"X-MOLTIN-CURRENCY":a},...c&&{"X-MOLTIN-CUSTOMER-TOKEN":c},...h},x=h["Content-Type"]?n:{body:JSON.stringify({data:n})},v=await this.fetch(d,{method:t,headers:y,...n&&x});if(204===v.status)return v.text();const T=await v.json();if(!v.ok)throw{statusCode:v.status,...T};return T},s.prototype.get=function(t,e){return this.request("GET",t,void 0,e)},s.prototype.put=function(t,e,n){return this.request("PUT",t,e,n)},s.prototype.post=function(t,e,n){return this.request("POST",t,e,n)},s.prototype.delete=function(t,e,n){return this.request("DELETE",t,e,n)};var p=e((function(t,e){t.exports=function(){var t=function(){},e={},n={},o={};function i(t,e){if(t){var i=o[t];if(n[t]=e,i)for(;i.length;)i[0](t,e),i.splice(0,1)}}function r(e,n){e.call&&(e={success:e}),n.length?(e.error||t)(n):(e.success||t)(e)}function s(e,n,o,i){var r,a,c=document,u=o.async,l=(o.numRetries||0)+1,p=o.before||t,d=e.replace(/[\?|#].*$/,""),f=e.replace(/^(css|img)!/,"");i=i||0,/(^css!|\.css$)/.test(d)?((a=c.createElement("link")).rel="stylesheet",a.href=f,(r="hideFocus"in a)&&a.relList&&(r=0,a.rel="preload",a.as="style")):/(^img!|\.(png|gif|jpg|svg|webp)$)/.test(d)?(a=c.createElement("img")).src=f:((a=c.createElement("script")).src=e,a.async=void 0===u||u),a.onload=a.onerror=a.onbeforeload=function(t){var c=t.type[0];if(r)try{a.sheet.cssText.length||(c="e")}catch(t){18!=t.code&&(c="e")}if("e"==c){if((i+=1)<l)return s(e,n,o,i)}else if("preload"==a.rel&&"style"==a.as)return a.rel="stylesheet";n(e,c,t.defaultPrevented)},!1!==p(e,a)&&c.head.appendChild(a)}function a(t,n,o){var a,c;if(n&&n.trim&&(a=n),c=(a?o:n)||{},a){if(a in e)throw"LoadJS";e[a]=!0}function u(e,n){!function(t,e,n){var o,i,r=(t=t.push?t:[t]).length,a=r,c=[];for(o=function(t,n,o){if("e"==n&&c.push(t),"b"==n){if(!o)return;c.push(t)}--r||e(c)},i=0;i<a;i++)s(t[i],o,n)}(t,(function(t){r(c,t),e&&r({success:e,error:n},t),i(a,t)}),c)}if(c.returnPromise)return new Promise(u);u()}return a.ready=function(t,e){return function(t,i){t=t.push?t:[t];var s,a,c,u=[],l=t.length,p=l;for(s=function(t,n){n.length&&u.push(t),--p||function(t){r(e,t)}(u)};l--;)a=t[l],(c=n[a])?s(a,c):(o[a]=o[a]||[]).push(s)}(t),a},a.done=function(t){i(t,[])},a.reset=function(){e={},n={},o={}},a.isDefined=function(t){return t in e},a}()}));const d=(f=f||Object.create(null),{on:function(t,e){(f[t]||(f[t]=[])).push(e)},off:function(t,e){f[t]&&f[t].splice(f[t].indexOf(e)>>>0,1)},emit:function(t,e){(f[t]||[]).slice().map((function(t){t(e)})),(f["*"]||[]).slice().map((function(n){n(t,e)}))}});var f;const h=function(t){var e=function(t){var e={},n={},o=function(t,i){if("@dispatch"!==t&&o("@dispatch",[t,i,e[t]]),e[t]){var r,s={};e[t].forEach((function(t){var e=t(n,i);e&&"function"!=typeof e.then&&(r=n=Object.assign({},n,e),Object.assign(s,e))})),r&&o("@changed",s)}},i={dispatch:o,get:function(){return n},on:function(t,n){return(e[t]||(e[t]=[])).push(n),function(){e[t]=e[t].filter((function(t){return t!==n}))}}};return t.forEach((function(t){t&&t(i)})),o("@init"),i}(t);return function(t){var n=[];return e.on("@changed",(function(e,o){t in o&&n.forEach((function(e){e(o[t])}))})),{subscribe:function(o){var i=e.get();return n.push(o),o(i[t]),function(){n=n.filter((function(t){return t!==o}))}},dispatch:e.dispatch}}}([t=>{t.on("@init",()=>({cart:{id:"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx".replace(/[x]/g,()=>(16*Math.random()|0).toString(16)),meta:null,items:[]}})),t.on("@dispatch",(t,[e,n])=>{}),t.on("@changed",({cart:t})=>{t.loading=!1,t.isEmpty=0===t.items.length,t.count=t.items.reduce((t,{quantity:e})=>t+e,0),t.subTotal=t.meta?t.meta.display_price.without_tax.formatted:0,t.items=t.items.filter(({type:t})=>"cart_item"===t||"custom_item"===t),t.promotionItems=t.items.filter(({type:t})=>"promotion_item"===t),t.taxItems=t.items.filter(({type:t})=>"tax_item"===t),t.averageApiRequest=function(t){if(!performance)return null;const e=performance.getEntriesByType("resource"),n=[];for(const t in e){const o=e[t];o.name.includes("https://api.moltin.com")&&n.push(Math.ceil(o.duration))}return n.length?n.reduce((t,e)=>t+e,0)/n.length:null}()||t.averageApiRequest}),t.on("setId",({cart:t},e)=>t.id=e),t.on("setCart",({cart:t},{data:e,meta:n})=>({cart:{...t,items:e,meta:n}})),t.on("getCart",async e=>{const n=await a.get(`carts/${e.cart.id}/items`);t.dispatch("setCart",n)}),t.on("deleteCart",async e=>{await a.delete(`carts/${e.cart.id}`),t.dispatch("setCart",{data:[],meta:null,error:null})}),t.on("addItem",async(e,{quantity:n=1,type:o="cart_item",...i})=>{const r=await a.post(`carts/${e.cart.id}/items`,{type:o,quantity:n,...i});t.dispatch("setCart",r)}),t.on("updateItem",async(e,n)=>{const{id:o,quantity:i}=n,{id:r}=e.cart;try{const e=await a.put(`carts/${r}/items/${o}`,{type:"cart_item",itemId:o,quantity:i});t.dispatch("setCart",e)}catch(t){console.log(t)}}),t.on("removeItem",async(e,n)=>{const{id:o}=e.cart,i=await a.delete(`carts/${o}/items/${n}`);t.dispatch("setCart",i)}),t.on("addPromotion",async(e,n)=>{const{id:o}=e.cart;try{const e=await a.post(`carts/${o}/items`,{type:"promotion_item",promotionCode:n});t.dispatch("setCart",e)}catch({statusCode:t}){console.log("Code expired or invalid")}finally{return{state:{cart:{error:"error"}}}}})},t=>{t.on("@init",()=>({modal:{route:"cart",open:!1}})),t.on("@changed",({modal:t})=>{t.checkingOut=["shipping","billing"].includes(t.route)}),t.on("changeRoute",({modal:t},e)=>({modal:{route:e,open:!0}})),t.on("goToCart",()=>t.dispatch("changeRoute","cart")),t.on("goToShipping",()=>t.dispatch("changeRoute","shipping")),t.on("goToBilling",()=>t.dispatch("changeRoute","billing")),t.on("goToOrders",()=>t.dispatch("changeRoute","orders")),t.on("goToLogin",()=>t.dispatch("changeRoute","login")),t.on("goToConfirmation",()=>t.dispatch("changeRoute","confirmation")),t.on("toggle",({modal:t})=>t.open=!t.open),t.on("openCart",({modal:t})=>({modal:{open:!0,route:"cart"}})),t.on("closeModal",e=>{const{checkingOut:n}=e.modal,{completed:o}=e.checkout;!o&&n||t.dispatch("close")}),t.on("close",({modal:t})=>({modal:{open:!1}})),t.on("continueShopping",({modal:t})=>({modal:{open:!1,route:"cart"}})),t.on("loadStripe",({modal:t},e)=>{p.isDefined("stripe")||(p(["https://js.stripe.com/v3"],"stripe",{numRetries:3}),p.ready("stripe",{success:()=>{Stripe(e)},error:()=>(console.error("Stripe Failed To Load"),null)}))})},t=>{t.on("@init",()=>({checkout:{route:"shipping",dirty:!1,completed:!1}}))},function(t){t.on("@changed",(function(t){o(Object.keys(t),e=>d.emit(e,t[e]))}))},function(t,e){t=t||[];var n=(e=e||{}).key||"storeon";return function(e){var o=!1;e.on("@init",(function(){o=!0;try{var t=localStorage.getItem(n);if(null!==t)return JSON.parse(t)}catch(t){}})),e.on("@dispatch",(function(e){if(o){var i={};0===t.length?i=e:t.forEach((function(t){i[t]=e[t]}));try{var r=JSON.stringify(i);localStorage.setItem(n,r)}catch(t){}}}))}}(["cart"],{key:"mcart"})]);export{s as M,t as a,h as b,e as c,c as d,d as e,l as f,o as i,n as p,u as s};
